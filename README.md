# intro/city

The *intro/city* project consists of tooling for automatic introspection and serialization of C data.
 - *intro* is parser which generates a c header with information about the types in your program.
 - The *intro* library provides procedures that work on this data.
 - *city* is a file format for arbitrary data serialization which is implemented in the library.

## Features
 - **No Friction**    
    - *intro* parses your already existing C code. No need to learn a new way to define a structure type.
    - No accessors. When you load city data, it is written directly to your structure.
    - City does not need IDs. It can use member names. If you change the name of a member, you can alias to the old name using an [attribute](doc/ATTRIBUTE.md#alias).
 - **Simple**    
    - The entire project is about 5000 lines of code, and most of that is for the parser. The library is only around 1000 lines (including the city implementation!).
    - The generated header is made up of pure data, no functions. The data does not even need to be initialized in any way.
    - The project is written in plain C99 code. No weird dyslexia-inciting C++ jargon. This also means APIs can be written for other languages.
    - The only link dependency is libc.
 - **Attributes**
    - Attributes provide extra information about a piece of data. They are defined with the `I` macro. They can be used for a variety of purposes, for example the `length` attribute defines a member which is the length of a buffer for serialization.
    - You can create **custom attributes** for your own purposes. This might include information for an interface such as ranges and precision, or alternative defaults for different situations.
    - There are a variety of attribute types including *int*, *float*, *member*, *string*, and *value*. For more information, see the [documentation for attributes](doc/ATTRIBUTE.md).

## Minimal Example

### [test/interactive\_test.c](test/interactive_test.c)
```C
#include "../lib/intro.h"

typedef int32_t s32;
typedef struct {
    s32 demo I(default 22);
    char * message I(default "empty message");
} SaveData;

#include "interactive_test.c.intro" // generated by intro

int
main() {
    SaveData save;

    void * city_data_handle = intro_load_city_file(&save, ITYPE(SaveData), "save.cty");
    if (!city_data_handle) {
        intro_set_defaults(&save, ITYPE(SaveData));
    }

    printf("Save file contents:\n");
    intro_print(&save, ITYPE(SaveData), NULL);

    char new_message [1024];
    printf("Enter a new message: ");
    fgets(new_message, sizeof(new_message), stdin);
    char * nl = strchr(new_message, '\n');
    if (nl) *nl = '\0';

    save.message = new_message;
    save.demo++;

    intro_create_city_file("save.cty", &save, ITYPE(SaveData));

    if (city_data_handle) free(city_data_handle);
    return 0;
}
```

### Output
```console
$ ./interactive_test
Save file contents:
{
    demo: s32 = 22;
    message: *char = "empty message";
}
Enter a new message: Hello there!
$ ./interactive_test
Save file contents:
{
    demo: s32 = 23;
    message: *char = "Hello there!";
}
```

For more examples, check out the test directory.

## Build/Install
`make release` will build a release version of the parser.

### Linux
`sudo make install` should set you up so you can invoke "intro" from anywhere.

## Integration
You can insert *intro* into the build process. For example a Makefile might look like this:

```Makefile
program: main.c data_types.h.intro
    $(CC) main.c $(CFLAGS) -o $@
    
data_types.h.intro: data_types.h
    intro data_types.h -o data_types.h.intro
```

`lib/intro.h` must be included *before* your types are declared, and the `*.intro` file must be included *after* all of the types are declared.   
  
You will probably want to use the library. The source is at `lib/introlib.c`. You can compile it with something like `cc -c lib/introlib.c`.    

## Disclaimers

 - *intro/city* is currently in beta. APIs and implementations are subject to change. If you intend to use this seriously, please be careful about updating. If you run into problems or friction that I am not aware of (check todo.txt and other issues), please create a new issue on [github](https://github.com/cyman-ide/introcity).
 - *intro/city* currently only supports x64 little-endian machines. This may change in the future.
 - the *intro* parser is currently not aware of C++ concepts such as `private` or methods. Only C99 features are fully supported. This may change in the future.
 - *intro/city* is not built to be safe with foreign data. Don't use these tools with data from a source you don't trust.

## Documentation
Documentation is provided in the [doc/](doc/) directory. It may not always be complete, but should cover the important things. It may be useful to look at the examples in [test/](test/) or the library source in [lib/](lib/).    
 - [usage](doc/USAGE.md)
 - [library reference](doc/LIB.md)
 - [attribute reference](doc/ATTRIBUTE.md)

## Credits
*intro/city* makes heavy use of `stb_ds.h` and `stb_sprintf.h` from the [stb libraries](https://github.com/nothings/stb) provided by Sean Barrett.
