# intro/city

The *intro/city* project consists of tooling for automatic introspection and serialization of C data.
 - *intro* is parser which generates a c header with information about the types in your program.
 - The *intro* library provides procedures that work on this data.
 - *city* is a file format for arbitrary data serialization which is supported by the library.

## Features
 - **No Friction**    
    - *intro* parses your already existing C code. No need to learn a new way to define a structure type.
    - No accessors. When you load city data, it is written directly to your structure.
    - City does not need IDs. It can use member names. If you change the name of a member, you can alias to the old name using an [attribute](https://github.com/cyman-ide/introcity/doc/ATTRIBUTE.md#alias).
    - The library includes a Dear ImGui widget which can allow you to inspect and edit your structures directly.
 - **Simple**    
    - The entire project is about 3000 lines of code, and most of that is for the parser. The library is only around 1000 lines (including the city implementation!).
    - The generated header is concise. It does not generate functions. The data does not even need to be initialized in any way.
    - The project is written in plain C99 code. No weird dyslexia-inciting C++ jargon. This also means APIs can be written for other languages.
 - **Attributes**
    - Attributes provide extra information about a piece of data. They are defined with the `I` macro. They can be used for a variety of purposes, for example the `length` attribute defines a member which is the length of a buffer for serialization.
    - You can create **custom attributes** for your own purposes. This might include information for an interface such as ranges and precision, or alternative defaults for different situations.
    - There are a variety of attribute types including *int*, *float*, *member*, *string*, and *value*. For more information, see the [documentation for attributes](https://github.com/cyman-ide/introcity/doc/ATTRIBUTE.md).

## Minimal Example

### test/interactive\_test.c
```C
typedef int32_t s32;
typedef struct {
    s32 demo I(default 22);

    char * message I(length len_message, default "empty message");
    int32_t len_message;
} SaveData;

#include "../lib/intro.h"
#include "interactive_test.c.intro" // generated by intro

int
main() {
    SaveData save;

    size_t last_file_data_length;
    void * last_file_data = read_entire_file("save.cty", &last_file_data_length);
    if (last_file_data) {
        intro_load_city(&save, ITYPE(SaveData), last_file_data);
    } else {
        intro_set_defaults(&save, ITYPE(SaveData));
    }

    printf("Save file contents:\n");
    intro_print(&save, ITYPE(SaveData), NULL);

    char new_message [1024];
    printf("Enter a new message: ");
    fgets(new_message, sizeof(new_message), stdin);

    save.message = new_message;
    save.demo++;

    size_t new_file_data_length;
    void * new_file_data = intro_create_city(&save, ITYPE(SaveData), &new_file_data_length);
    dump_to_file("save.cty", new_file_data, new_file_data_length);

    free(new_file_data);
    free(last_file_data);

    return 0;
}
```

### Output
```console
$ ./db_interactive_test
Save file contents:
{
    demo: s32 = 22;
    message: *char = "empty message";
    len_message: int32_t = 14;
}
Enter a new message: Hello there!
$ ./db_interactive_test
Save file contents:
{
    demo: s32 = 23;
    message: *char = "Hello there!";
    len_message: int32_t = 13;
}
[...]
```

For more examples, check out the test directory.

## Build/Install
`make r_intro` will build a release version of the parser.

### Linux/MSYS
`sudo make install` will build `r_intro` and copy it to `/usr/local/bin/intro`.

## Integration
You can insert *intro* into the build process. For example a Makefile might look like this:

```Makefile
program: main.c data_types.h.intro
    $(CC) main.c $(CFLAGS) -o $@
    
data_types.h.intro: data_types.h
    intro data_types.h -o data_types.h.intro
```

the `*.intro` file must be included *after* all of the types are declared. `lib/types.h` or `lib/intro.h` (which includes types.h) must be included before the `*.intro` file.   

You will probably want to use the library. The header for the library is at `lib/intro.h`. The source is at `lib/lib.c`. You can compile it with something like `cc -c lib/lib.c -o introlib.o`.    

## Disclaimers

 - *intro/city* is currently in beta. APIs and implementations are subject to change. If you intend to use this seriously, please be careful about updating. If you run into problems or friction that I am not aware of (check todo.txt and other issues), please create a new issue on [github](https://github.com/cyman-ide/introcity).
 - *intro/city* currently only supports x64 little-endian machines. This may change in the future.
 - the *intro* parser is currently not aware of C++ concepts such as `private` or methods. It can only work on valid C code. This may change in the future.
 - *intro/city* is not built to be safe with foreign data. Don't use these tools with data from a source you don't trust.

## Documentation
Documentation is provided in the `doc/` directory. It may not always be complete, but should cover the important things.

## Credits
*intro/city* makes heavy use of very good `stb_ds.h` and `stb_sprintf.h` from the [stb libraries](https://github.com/nothings/stb) provided by Sean Barrett.
